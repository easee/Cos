stages:
  - stage: continuous_integration
    displayName: 'Build and test'
    pool:
      name: 'AWS EC2 Pool'
    jobs:
      - job: Build
        displayName: 'Build and test'
        steps:
          - task: AWSShellScript@1
            displayName: 'Build, test and pack'
            inputs:
              arguments: 'CreateNuGetPackage'
              filePath: './build.cmd'
              scriptType: 'filePath'
          - task: PublishPipelineArtifact@1
            inputs:
              targetPath: '$(System.DefaultWorkingDirectory)/artifacts'
              artifactName: 'Cos'
  - stage: 'PublishNuGetPackage'
    displayName: 'Publish NuGet Package'
    dependsOn: 'continuous_integration'
    pool: 'AWS EC2 Pool'
    condition: and(succeeded(), eq(variables['Build.SourceBranch'], 'refs/heads/feature/nuget'))
    jobs:
    - job:
      displayName: 'Push NuGet package'
      steps:
      - checkout: none
      - task: DownloadPipelineArtifact@2
        inputs:
          artifact: Cos
          patterns: '**/*.nupkg'
          path: $(System.DefaultWorkingDirectory)/bin
      # Push non test NuGet packages from a build to internal organization Feed
      - task: DotNetCoreCLI@2
        inputs:
          command: 'push'
          searchPatternPush: '$(System.DefaultWorkingDirectory)/bin/**/*.nupkg'
          feedPublish: 'easee-norway'